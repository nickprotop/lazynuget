name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      matrix:
        rid: [linux-x64, linux-arm64, osx-x64, osx-arm64, win-x64, win-arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish
        env:
          RID: ${{ matrix.rid }}
        run: |
          dotnet publish -c Release \
            -r "$RID" \
            --self-contained true \
            -p:PublishSingleFile=true \
            -o ./publish/"$RID"

      - name: Rename binary
        env:
          RID: ${{ matrix.rid }}
        run: |
          cd publish/"$RID"
          if [[ "$RID" == win-* ]]; then
            mv LazyNuGet.exe "lazynuget-${RID}.exe"
          else
            mv LazyNuGet "lazynuget-${RID}"
            chmod +x "lazynuget-${RID}"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.rid }}
          path: publish/${{ matrix.rid }}/lazynuget-*

  vscode-extension:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      matrix:
        include:
          - rid: linux-x64
            vscode-target: linux-x64
            binary: lazynuget-linux-x64
          - rid: linux-arm64
            vscode-target: linux-arm64
            binary: lazynuget-linux-arm64
          - rid: osx-x64
            vscode-target: darwin-x64
            binary: lazynuget-osx-x64
          - rid: osx-arm64
            vscode-target: darwin-arm64
            binary: lazynuget-osx-arm64
          - rid: win-x64
            vscode-target: win32-x64
            binary: lazynuget-win-x64.exe
          - rid: win-arm64
            vscode-target: win32-arm64
            binary: lazynuget-win-arm64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.rid }}
          path: vscode-extension/bin

      - name: Prepare bundled binary
        env:
          BINARY: ${{ matrix.binary }}
          RID: ${{ matrix.rid }}
        run: |
          cd vscode-extension/bin
          # Rename to the standard name the extension expects
          if [[ "$RID" == win-* ]]; then
            mv "$BINARY" lazynuget.exe
          else
            mv "$BINARY" lazynuget
            chmod +x lazynuget
          fi

      - name: Set extension version
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          cd vscode-extension
          npm version "$VERSION" --no-git-tag-version

      - name: Install dependencies
        working-directory: vscode-extension
        run: npm ci

      - name: Rebuild native modules for Electron
        working-directory: vscode-extension
        run: npm run rebuild

      - name: Build extension
        working-directory: vscode-extension
        run: npm run build

      - name: Package VSIX
        env:
          VSCODE_TARGET: ${{ matrix.vscode-target }}
        run: |
          cd vscode-extension
          npx @vscode/vsce package --target "$VSCODE_TARGET"

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-${{ matrix.vscode-target }}
          path: vscode-extension/*.vsix

  release:
    needs: [build, vscode-extension]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          path: publish
          pattern: binary-*
          merge-multiple: true

      - name: Download all VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          path: vsix
          pattern: vsix-*
          merge-multiple: true

      - name: Copy scripts
        run: |
          cp install.sh ./publish/install.sh
          cp uninstall.sh ./publish/uninstall.sh
          cp install.ps1 ./publish/install.ps1
          cp uninstall.ps1 ./publish/uninstall.ps1
          chmod +x ./publish/install.sh
          chmod +x ./publish/uninstall.sh

      - name: Generate checksums
        run: |
          cd publish
          sha256sum lazynuget-linux-x64 >> SHA256SUMS
          sha256sum lazynuget-linux-arm64 >> SHA256SUMS
          sha256sum lazynuget-osx-x64 >> SHA256SUMS
          sha256sum lazynuget-osx-arm64 >> SHA256SUMS
          sha256sum lazynuget-win-x64.exe >> SHA256SUMS
          sha256sum lazynuget-win-arm64.exe >> SHA256SUMS
          cd ../vsix
          sha256sum *.vsix >> ../publish/SHA256SUMS

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          git fetch --tags --force
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${CURRENT_TAG}$" | head -n 1)

          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log "${PREV_TAG}..${CURRENT_TAG}" --pretty=format:"- %s (%h)" --no-merges)
          fi

          echo "CHANGELOG<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGELOG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            publish/lazynuget-linux-x64
            publish/lazynuget-linux-arm64
            publish/lazynuget-osx-x64
            publish/lazynuget-osx-arm64
            publish/lazynuget-win-x64.exe
            publish/lazynuget-win-arm64.exe
            publish/install.sh
            publish/uninstall.sh
            publish/install.ps1
            publish/uninstall.ps1
            publish/SHA256SUMS
            vsix/*.vsix
          body: |
            # LazyNuGet ${{ steps.version.outputs.VERSION }}

            A terminal-based NuGet package manager for .NET projects, inspired by lazygit.

            ## Installation

            ### VS Code Extension
            Download the `.vsix` file for your platform and install via:
            ```
            code --install-extension lazynuget-<platform>.vsix
            ```

            ### Linux
            ```bash
            curl -fsSL https://raw.githubusercontent.com/nickprotop/lazynuget/main/install.sh | bash
            ```

            ### macOS
            ```bash
            curl -fsSL https://raw.githubusercontent.com/nickprotop/lazynuget/main/install.sh | bash
            ```
            > If macOS blocks the binary, run: `xattr -d com.apple.quarantine $(which lazynuget)`

            ### Windows (PowerShell)
            ```powershell
            irm https://raw.githubusercontent.com/nickprotop/lazynuget/main/install.ps1 | iex
            ```

            ### Manual Install
            Download the binary for your platform:
            | Platform | Binary |
            |----------|--------|
            | Linux x64 | `lazynuget-linux-x64` |
            | Linux ARM64 | `lazynuget-linux-arm64` |
            | macOS x64 (Intel) | `lazynuget-osx-x64` |
            | macOS ARM64 (Apple Silicon) | `lazynuget-osx-arm64` |
            | Windows x64 | `lazynuget-win-x64.exe` |
            | Windows ARM64 | `lazynuget-win-arm64.exe` |

            ## What's Changed

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## Checksums

            See `SHA256SUMS` for file verification.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: npx @vscode/vsce publish --packagePath vsix/*.vsix
